<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" sizes="192x192" href="/app-icon-ios.png" />
    <link rel="shortcut icon" type="image/png" href="/app-icon-ios.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="description" content="Join Kaden and Adelynn on an epic space adventure! Battle enemies, collect power-ups, and unlock new ships in this action-packed space shooter designed for kids and families." />
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4ecdc4" />
    <meta name="mobile-web-app-capable" content="yes" />
    <link rel="manifest" href="/manifest.json" />
    
    <!-- Apple iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Kaden & Adelynn Space Adventures" />
    <link rel="apple-touch-icon" href="/icon-192.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="/icon-192.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="/icon-512.png" />
    
    <!-- Prevent iOS Safari from adding address bar -->
    <meta name="format-detection" content="telephone=no" />
    
    <title>Kaden & Adelynn Space Adventures</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
      // Firebase configuration is loaded via Firebase Hosting auto-init
      // Configuration is provided by Firebase Hosting at /__/firebase/init.js
      // For local development, create a .env file with your Firebase config
      // See .env.example for template
      
      // If Firebase Hosting auto-init is not available, initialize manually
      // (This will be handled by Firebase Hosting in production)
      if (typeof firebase !== 'undefined' && !firebase.apps.length) {
        // Load config from environment or use Firebase Hosting auto-init
        // For production, Firebase Hosting provides config automatically
        console.log('Firebase will be initialized by hosting or environment config');
      }
    </script>
    
    <style>
      /* Prevent iOS bounce scrolling and address bar issues */
      html, body {
        height: 100%;
        width: 100%;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        margin: 0;
        padding: 0;
      }
      
      /* Prevent bounce scrolling on body */
      body {
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }
      
      #root {
        height: 100%;
        width: 100%;
        position: fixed;
        top: 0;
        left: 0;
        overflow: hidden;
      }
      
      /* Main menu is the scrollable container */
      .main-menu {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior-y: contain;
        overscroll-behavior: contain;
        touch-action: pan-y;
        /* Prevent iOS bounce */
        -webkit-overflow-scrolling: touch;
        /* Ensure smooth scrolling */
        scroll-behavior: smooth;
      }
      
      /* Prevent text selection on iOS */
      * {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
    <script>
      // Register service worker for PWA with update checking
      if ('serviceWorker' in navigator) {
        let refreshing = false
        
        // Register service worker
        navigator.serviceWorker.register('/sw.js', { updateViaCache: 'none' })
          .then((registration) => {
            console.log('SW registered:', registration)
            
            // Check for updates more frequently (every 5 minutes)
            setInterval(() => {
              registration.update().catch(err => console.log('Update check failed:', err))
            }, 300000) // 5 minutes
            
            // Force immediate update check on registration
            registration.update()
            
            // Listen for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing
              console.log('SW update found, installing new version')
              
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed') {
                  if (navigator.serviceWorker.controller) {
                    // New service worker is ready, prompt user to refresh
                    console.log('New SW installed, ready to activate')
                    // Auto-reload after short delay to ensure update
                    setTimeout(() => {
                      newWorker.postMessage({ type: 'SKIP_WAITING' })
                      window.location.reload()
                    }, 1000)
                  } else {
                    // First install, no reload needed
                    console.log('SW installed for first time')
                  }
                }
              })
            })
            
            // Listen for messages from service worker
            navigator.serviceWorker.addEventListener('message', (event) => {
              if (event.data && event.data.type === 'SW_UPDATED') {
                console.log('SW updated to version:', event.data.version)
                if (!refreshing) {
                  refreshing = true
                  window.location.reload()
                }
              }
            })
          })
          .catch((error) => {
            console.log('SW registration failed:', error)
          })
        
        // Check for updates on page visibility change
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden && 'serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistration().then((registration) => {
              if (registration) {
                registration.update()
              }
            })
          }
        })
      }
      
      // Prevent iOS Safari bounce scrolling (but allow menu and story scrolling)
      let touchStartY = 0
      let touchStartX = 0
      
      document.addEventListener('touchstart', (e) => {
        touchStartY = e.touches[0].clientY
        touchStartX = e.touches[0].clientX
      }, { passive: true })
      
      document.addEventListener('touchmove', (e) => {
        const target = e.target
        const menu = document.querySelector('.main-menu')
        const storyOverlay = document.querySelector('.story-overlay')
        const storyContainer = document.querySelector('.story-container')
        
        // Always allow scrolling if we're inside the menu
        if (menu && (menu.contains(target) || target.closest('.main-menu'))) {
          const touchY = e.touches[0].clientY
          const touchX = e.touches[0].clientX
          const deltaY = touchY - touchStartY
          const deltaX = touchX - touchStartX
          
          // Check if this is a vertical scroll gesture
          if (Math.abs(deltaY) > Math.abs(deltaX)) {
            const menuScrollTop = menu.scrollTop
            const menuScrollHeight = menu.scrollHeight
            const menuClientHeight = menu.clientHeight
            
            // Allow scrolling if:
            // 1. Scrolling down and not at bottom, OR
            // 2. Scrolling up and not at top
            const isScrollingDown = deltaY > 0
            const isScrollingUp = deltaY < 0
            const isAtTop = menuScrollTop <= 0
            const isAtBottom = menuScrollTop + menuClientHeight >= menuScrollHeight - 1
            
            if ((isScrollingDown && !isAtBottom) || (isScrollingUp && !isAtTop)) {
              return // Allow the scroll
            }
          }
          return // Allow menu interactions
        }
        
        // Always allow scrolling if we're inside the story overlay/container
        if (storyOverlay && (storyOverlay.contains(target) || target.closest('.story-overlay') || target.closest('.story-container'))) {
          return // Allow story scrolling
        }
        
        // Prevent scrolling outside menu and story
        e.preventDefault()
      }, { passive: false })
      
      // Fix iOS viewport height issue
      function setViewportHeight() {
        const vh = window.innerHeight * 0.01
        document.documentElement.style.setProperty('--vh', `${vh}px`)
      }
      setViewportHeight()
      window.addEventListener('resize', setViewportHeight)
      window.addEventListener('orientationchange', () => {
        setTimeout(setViewportHeight, 100)
      })
      
      // Prevent double-tap zoom on iOS (but allow on menu)
      let lastTouchEnd = 0
      document.addEventListener('touchend', (e) => {
        const isInMenu = e.target.closest('.main-menu') || 
                        e.target.closest('.menu-container')
        if (isInMenu) {
          return // Allow double-tap in menu
        }
        const now = Date.now()
        if (now - lastTouchEnd <= 300) {
          e.preventDefault()
        }
        lastTouchEnd = now
      }, false)
      
      // Ensure menu scrolling works on iOS
      function ensureMenuScrolling() {
        const menu = document.querySelector('.main-menu')
        if (menu) {
          // Force iOS to recognize this as scrollable
          menu.style.webkitOverflowScrolling = 'touch'
          menu.style.overflowY = 'auto'
          
          // Prevent body from interfering
          document.body.style.overflow = 'hidden'
          document.body.style.position = 'fixed'
        }
      }
      
      // Watch for menu changes
      const observer = new MutationObserver(() => {
        setTimeout(ensureMenuScrolling, 50)
      })
      observer.observe(document.getElementById('root'), {
        childList: true,
        subtree: true
      })
      
      // Initial check
      setTimeout(ensureMenuScrolling, 100)
      window.addEventListener('load', ensureMenuScrolling)
    </script>
  </body>
</html>
